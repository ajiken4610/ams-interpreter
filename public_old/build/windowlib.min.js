"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(o,m,k,k2){void 0===k2&&(k2=k),Object.defineProperty(o,k2,{enumerable:!0,get:function(){return m[k]}})}:function(o,m,k,k2){void 0===k2&&(k2=k),o[k2]=m[k]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(o,v){Object.defineProperty(o,"default",{enumerable:!0,value:v})}:function(o,v){o.default=v}),__importStar=this&&this.__importStar||function(mod){if(mod&&mod.__esModule)return mod;var result={};if(null!=mod)for(var k in mod)"default"!==k&&Object.prototype.hasOwnProperty.call(mod,k)&&__createBinding(result,mod,k);return __setModuleDefault(result,mod),result},__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ToastUtils=exports.AjaxFragment=exports.FragmentManager=exports.FragmentFactory=exports.Fragment=exports.LevelPageSystem=exports.State=exports.HashSystem=exports.Hash=exports.URLSystem=exports.URLUtilities=void 0;const Utils=__importStar(require("./utils")),{JSDOM:JSDOM}=require("jsdom"),{window:window}=new JSDOM(""),$=require("jquery")(window);class URLUtilities{static replace(newURL){history.replaceState(null,"",newURL)}static push(newURL){history.pushState(null,"",newURL)}static get(){return location.href}static reload(){location.reload()}}exports.URLUtilities=URLUtilities;class URLSystem{static addOnPageStateChangeListener(listener){this.onPageStateChangeListeners.push(listener),listener.createCalled||listener.onCreate(location.href)}static deleteOnPageStateChangeListener(listener){this.onPageStateChangeListeners=this.onPageStateChangeListeners.filter(item=>item!==listener)}static staticInitialize(){this.onPageStateChangeListeners.forEach(listener=>{listener.createCalled||(listener.onCreate(location.href),listener.createCalled=!0)}),$(()=>{$(window).on("beforeunload",()=>{this.onPageStateChangeListeners.forEach(listener=>{listener.onDestroy(location.href)})})})}}exports.URLSystem=URLSystem,URLSystem.OnPageStateChangeListener=class{constructor(){this.createCalled=!1}onCreate(url){throw"Listener method must be overridden."}onDestroy(url){throw"Listener method must be overridden."}},URLSystem.onPageStateChangeListeners=[],URLSystem.staticInitialize();class Hash{static replace(newHash){history.replaceState(null,"","#"+newHash),$(window).trigger("hashchange")}static push(newHash){history.pushState(null,"","#"+newHash),$(window).trigger("hashchange")}static get(){return location.hash.substring(1)}}exports.Hash=Hash;class HashSystem{static addOnHashChangeListener(listener){this.onHashChangeListeners.push(listener)}static deleteOnHashChangeListener(listener){this.onHashChangeListeners=this.onHashChangeListeners.filter(item=>item!==listener)}static staticInitialize(){$(window).on("hashchange",()=>{let newHash=location.hash.substring(1);this.onHashChangeListeners.forEach(listener=>{listener.onChange(this.oldHash,newHash)}),this.oldHash=newHash})}}exports.HashSystem=HashSystem,HashSystem.OnHashChangeListener=class{onChange(oldHash,newHash){throw"Listener method must be overridden."}},HashSystem.onHashChangeListeners=[],HashSystem.oldHash="",HashSystem.staticInitialize();class State{constructor(text){try{this.state=text?decodeURIComponent(text):null}catch(e){console.error(e),this.state=null}}convertToText(){return this.state?encodeURIComponent(this.state):null}}exports.State=State;class LevelPageSystem{constructor(){throw"This class cannot be instanced"}static addCallback(levelPage){this.levelPages.push(levelPage)}static deleteCallback(levelPage){this.levelPages=this.levelPages.filter(item=>item!==levelPage)}static staticInitialize(){let listener=new class extends HashSystem.OnHashChangeListener{onChange(oldHash,newHash){let splitedOld=oldHash.split("/"),splitedNew=newHash.split("/");for(let i=0;i<Math.max(splitedOld.length,splitedNew.length);i++){let currentNew=splitedNew[i],currentOld=splitedOld[i];!currentOld&&currentNew?LevelPageSystem.levelPages.forEach(callback=>{callback.onCreate(i,currentNew)}):!currentNew&&currentOld?LevelPageSystem.levelPages.forEach(callback=>{callback.onDestroy(i)}):currentNew!==currentOld&&currentNew&&currentOld&&LevelPageSystem.levelPages.forEach(callback=>{callback.onChangeState(i,currentOld,currentNew)})}}};HashSystem.addOnHashChangeListener(listener)}}exports.LevelPageSystem=LevelPageSystem,LevelPageSystem.Callback=class{onCreate(index,name){throw"Call method must be overridden."}onDestroy(index){throw"Call method must be overridden."}onChangeState(index,oldState,newState){throw"Call method must be overridden."}},LevelPageSystem.levelPages=[],LevelPageSystem.staticInitialize();class Fragment{constructor(){this.manager=null,this.view=null}onCreate(){}onViewCreated(view){}onResume(){}onChangeState(oldState,newState){}onPause(){}onDestroy(){}onSaveState(state){}invalidateHash(){var _a;null===(_a=this.manager)||void 0===_a||_a.invalidateHash()}escape(){var _a;null===(_a=this.manager)||void 0===_a||_a.pop()}push(fragmentName){var _a;null===(_a=this.manager)||void 0===_a||_a.push(fragmentName)}replace(fragmentName){var _a;null===(_a=this.manager)||void 0===_a||_a.replace(fragmentName)}showOverlay(){var _a;null===(_a=this.manager)||void 0===_a||_a.showOverlay()}hideOverlay(){var _a;null===(_a=this.manager)||void 0===_a||_a.hideOverlay()}onStartManagement(manager){this.manager=manager}}exports.Fragment=Fragment;class FragmentFactory{newFragment(fragmentName){throw"Factory method must be implemented."}getFragmentName(fragment){throw"Factory method must be implemented."}}exports.FragmentFactory=FragmentFactory;class FragmentManager extends LevelPageSystem.Callback{constructor(view,fragmentFactory){super(),this.fragments=[],this.sync=new Utils.Synchronizer,this.shownOverlay=0,this.view=view,this.overlay=$('<div class="full-overlay"></div>'),this.overlay.appendTo(view),this.fragmentFactory=fragmentFactory,LevelPageSystem.addCallback(this),$(window).trigger("hashchange")}showOverlay(){this.shownOverlay++,this.overlay.addClass("shown")}hideOverlay(){0>=--this.shownOverlay&&this.overlay.removeClass("shown")}replace(fragmentName){let splitedHash=FragmentManager.getSplitedHash();splitedHash.pop(),splitedHash.push(fragmentName),Hash.push(splitedHash.join("/"))}push(fragmentName){let splitedHash=FragmentManager.getSplitedHash();splitedHash.push(fragmentName),Hash.push(splitedHash.join("/"))}pop(){let splitedHash=FragmentManager.getSplitedHash();splitedHash.pop(),Hash.push(splitedHash.join("/"))}static getSplitedHash(){let splitedHash=Hash.get().split("/");return splitedHash=splitedHash.filter(element=>element),splitedHash}invalidateHash(){let ret="";this.fragments.forEach(fragment=>{if(fragment){ret+=this.fragmentFactory.getFragmentName(fragment);let state=new State;fragment.onSaveState(state);let stateText=state.convertToText();stateText&&(ret+="-",ret+=stateText),ret+="/"}}),ret=ret.substring(0,ret.length-1),Hash.push(ret)}invalidateFragments(){let originalHash=Hash.get();Hash.replace(""),Hash.replace(originalHash)}onCreate(index,name){return __awaiter(this,void 0,void 0,(function*(){this.showOverlay(),yield this.sync.synchronized(()=>__awaiter(this,void 0,void 0,(function*(){var _a,_b,_c,_d,_e,_f;let splitedName=name.split("-"),fragmentName=splitedName.splice(0,1)[0],fragmentState=splitedName.join("-"),currentFragment=this.fragments[index];this.fragments[index-1]&&(null===(_a=this.fragments[index-1])||void 0===_a||_a.onPause()),currentFragment&&this.fragmentFactory.getFragmentName(currentFragment)===fragmentName||(currentFragment=this.fragments[index]=this.fragmentFactory.newFragment(fragmentName)),null===(_b=this.fragments[index])||void 0===_b||_b.onStartManagement(this),yield null===(_c=this.fragments[index])||void 0===_c?void 0:_c.onCreate();let view=$('<div class="fragment"></div>');currentFragment&&(currentFragment.view=view),view.appendTo(this.view),yield null===(_d=this.fragments[index])||void 0===_d?void 0:_d.onViewCreated(view),yield null===(_e=this.fragments[index])||void 0===_e?void 0:_e.onChangeState(new State,new State(fragmentState)),yield null===(_f=this.fragments[index])||void 0===_f?void 0:_f.onResume(),yield Utils.Sleeper.sleep(50),view.addClass("shown")}))),this.hideOverlay()}))}onDestroy(index){return __awaiter(this,void 0,void 0,(function*(){this.showOverlay(),yield this.sync.synchronized(()=>__awaiter(this,void 0,void 0,(function*(){var _a,_b,_c,_d,_e,_f,_g;this.fragments[index]&&(yield null===(_a=this.fragments[index])||void 0===_a?void 0:_a.onPause(),yield null===(_c=null===(_b=this.fragments[index])||void 0===_b?void 0:_b.view)||void 0===_c?void 0:_c.removeClass("shown"),yield Utils.Sleeper.sleep(500),yield null===(_e=null===(_d=this.fragments[index])||void 0===_d?void 0:_d.view)||void 0===_e?void 0:_e.remove(),yield null===(_f=this.fragments[index])||void 0===_f?void 0:_f.onDestroy(),this.fragments[index]=null),null!==this.fragments[index-1]&&(yield null===(_g=this.fragments[index-1])||void 0===_g?void 0:_g.onResume())}))),this.hideOverlay()}))}onChangeState(index,oldName,newName){return __awaiter(this,void 0,void 0,(function*(){let splitedOld=oldName.split("-"),fragmentOldName=splitedOld.splice(0,1)[0],fragmentOldState=splitedOld.join("-"),splitedNew=newName.split("-"),fragmentNewName=splitedNew.splice(0,1)[0],fragmentNewState=splitedNew.join("-"),currentFragment=this.fragments[index];currentFragment&&this.fragmentFactory.getFragmentName(currentFragment)===fragmentNewName?yield currentFragment.onChangeState(new State(fragmentOldState),new State(fragmentNewState)):currentFragment&&(this.onDestroy(index),this.onCreate(index,newName))}))}}exports.FragmentManager=FragmentManager;class AjaxFragment extends Fragment{constructor(ajaxURL){super(),this.url=ajaxURL}onViewCreated(view){let deferred=$.Deferred();return view.load(this.url,(response,status)=>{"success"!==status&&view.html(response),deferred.resolve()}),deferred.promise()}}exports.AjaxFragment=AjaxFragment;class ToastUtils{static showToast(message){$("#toast").toast("hide"),$("#toast-body").html(message),$("#toast").toast("show")}}exports.ToastUtils=ToastUtils;